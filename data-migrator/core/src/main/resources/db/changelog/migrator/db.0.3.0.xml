<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ Copyright Camunda Services GmbH and/or licensed to Camunda Services GmbH under
  ~ one or more contributor license agreements. See the NOTICE file distributed
  ~ with this work for additional information regarding copyright ownership.
  ~ Licensed under the Camunda License 1.0. You may not use this file
  ~ except in compliance with the Camunda License 1.0.
  -->
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-latest.xsd">

  <changeSet id="tag_before_modify_c8_key_column" author="Camunda">
    <tagDatabase tag="tag_before_modify_c8_key_column"/>
  </changeSet>

  <!-- Non-Oracle databases: modify data type directly -->
  <changeSet id="modify_c8_key_column_to_varchar" author="Camunda" dbms="!oracle">
    <!-- Drop index first as SQL Server doesn't allow modifying indexed columns -->
    <dropIndex tableName="${prefix}MIGRATION_MAPPING"
               indexName="${prefix}IDX_MIGRATION_MAPPING_C8_KEY"/>

    <modifyDataType tableName="${prefix}MIGRATION_MAPPING"
                    columnName="C8_KEY"
                    newDataType="VARCHAR(255)"/>

    <!-- Recreate the index after column modification -->
    <createIndex tableName="${prefix}MIGRATION_MAPPING"
                 indexName="${prefix}IDX_MIGRATION_MAPPING_C8_KEY">
      <column name="C8_KEY"/>
    </createIndex>
  </changeSet>

  <!-- Oracle: use temp column to work around ORA-01439
       (cannot change datatype of a non-empty column) -->
  <changeSet id="modify_c8_key_column_to_varchar" author="Camunda" dbms="oracle">

  <addColumn tableName="${prefix}MIGRATION_MAPPING">
      <column name="C8_KEY_TMP" type="VARCHAR2(255)"/>
    </addColumn>

    <sql>UPDATE ${prefix}MIGRATION_MAPPING
         SET C8_KEY_TMP = C8_KEY</sql>

    <dropIndex tableName="${prefix}MIGRATION_MAPPING"
               indexName="${prefix}IDX_MIGRATION_MAPPING_C8_KEY"/>

    <dropColumn tableName="${prefix}MIGRATION_MAPPING" columnName="C8_KEY"/>

    <renameColumn tableName="${prefix}MIGRATION_MAPPING"
                  oldColumnName="C8_KEY_TMP"
                  newColumnName="C8_KEY"
                  columnDataType="VARCHAR2(255)"/>

    <createIndex tableName="${prefix}MIGRATION_MAPPING"
                 indexName="${prefix}IDX_MIGRATION_MAPPING_C8_KEY">
      <column name="C8_KEY"/>
    </createIndex>
  </changeSet>

</databaseChangeLog>
